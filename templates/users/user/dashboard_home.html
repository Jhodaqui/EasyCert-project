{% extends "base.html" %}
{% block content %}
<div class="container-fluid p-0">
  <!-- Header -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <div class="d-flex align-items-center">
      <img src="/static/img/EasyCert" alt="EasyCert Logo" class="me-2" style="height: 40px;">
      <span class="navbar-brand fw-bold">EASYCERT</span>
    </div>
    <div class="ms-auto d-flex align-items-center">
      <span class="text-light me-3">
        <i class="fas fa-user-circle me-1"></i> Hola, {{ user.nombres }}
      </span>
      <a href="{% url 'logout' %}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-sign-out-alt me-1"></i> Cerrar Sesión
      </a>
    </div>
  </nav>

  <!-- Contenido -->
  <div class="container my-4">
    <div class="card shadow">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="fas fa-file-alt me-2 text-primary"></i> Solicitudes de Constancias
        </h4>
        <div>
          <span class="badge bg-primary me-3">{{ solicitudes|length }} solicitudes</span>
          <button type="button" class="btn btn-sm btn-success" id="abrirFormularioBtn">
            <i class="fas fa-plus-circle me-1"></i> Solicitar constancia
          </button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th>Usuario</th>
                <th>Documento</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for s in solicitudes %}
              <tr class="solicitud-row" data-tipo="{{ s.tipo }}" data-estado="{{ s.estado }}" data-fecha="{{ s.creado_en|date:'Y-m-d' }}">
                <td>{{ s.usuario.nombres }} {{ s.usuario.apellidos }}</td>
                <td>{{ s.usuario.numero_documento }}</td>
                <td>
                  <span class="badge 
                    {% if s.estado == 'pendiente' %} bg-warning text-dark 
                    {% elif s.estado == 'aprobado' %} bg-success 
                    {% elif s.estado == 'rechazado' %} bg-danger 
                    {% else %} bg-secondary {% endif %}">
                    {{ s.get_estado_display }}
                  </span>
                </td>
                <td>
                  <a href="#" class="btn btn-sm btn-primary" title="Descargar PDF">
                    <i class="fas fa-file-download me-1"></i> Descargar PDF
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center py-4">
                  <i class="fas fa-folder-open fa-2x text-muted mb-2"></i>
                  <h5 class="mb-1">No hay solicitudes</h5>
                  <p class="text-muted">No se encontraron solicitudes de constancias.</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Bootstrap -->
<div class="modal fade" id="formularioModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus-circle me-1 text-primary"></i> Solicitar Constancia
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="modalFormularioContenido">
        <!-- Aquí se cargará el formulario vía AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let formDirty = false;        // Detecta si hay cambios en el formulario
  let formOpened = false;       // Detecta si el modal ya fue abierto
  let formSubmitted = false;    // Detecta si el formulario fue enviado correctamente
  let forceReload = false;      // Evita la alerta cuando la recarga es intencional

  const abrirBtn = document.getElementById("abrirFormularioBtn");
  const modalBody = document.getElementById("modalFormularioContenido");
  const modalEl = document.getElementById("formularioModal");
  const modal = new bootstrap.Modal(modalEl);

  // --- Mostrar advertencia SOLO si el formulario fue abierto, tiene cambios y no es recarga intencional
  window.addEventListener('beforeunload', function (e) {
    if (formOpened && formDirty && !formSubmitted && !forceReload) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // --- Marcar formulario como "dirty" cuando el usuario cambia algo
  document.addEventListener('input', (e) => {
    if (e.target.closest && e.target.closest('#constanciaForm')) {
      formDirty = true;
    }
  });
  document.addEventListener('change', (e) => {
    if (e.target.closest && e.target.closest('#constanciaForm')) {
      formDirty = true;
    }
  });

  // --- Abrir modal y cargar formulario por AJAX
  abrirBtn.addEventListener("click", function () {
    fetch("{% url 'formulario_constancia' %}", {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
      modalBody.innerHTML = data.form_html;

      const form = document.getElementById("constanciaForm");
      if (form) {
        // Sincronizar valores iniciales
        form.querySelectorAll('input, textarea, select').forEach(input => {
          try { input.defaultValue = input.value; } catch(e){ /* ignore */ }
        });

        // Reseteamos estados
        formDirty = false;
        formOpened = true;
        formSubmitted = false;

        // Asociar evento de submit
        form.addEventListener("submit", handleFormSubmit);
      }

      modal.show();
    })
    .catch(error => {
      modalBody.innerHTML = `<div class="alert alert-danger">Error al cargar el formulario</div>`;
      modal.show();
    });
  });

  // --- Manejo de envío del formulario
  function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');

    // Mostrar loading
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
    }

    fetch("{% url 'procesar_constancia' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie('csrftoken')
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Error en la respuesta del servidor');
      return response.json();
    })
    .then(data => {
      if (data.success) {
        formSubmitted = true; 
        formDirty = false;

        // 1. Limpiar y sincronizar formulario
        form.reset();
        form.querySelectorAll('input, textarea, select').forEach(input => {
          try { input.defaultValue = input.value; } catch(e){/* ignore */ }
        });

        // 2. Mostrar mensaje de éxito
        modalBody.innerHTML = `
          <div class="alert alert-success text-center">
            <h4>¡Solicitud enviada!</h4>
            <p>${data.message}</p>
            <p>La página se recargará automáticamente...</p>
          </div>
        `;

        // 3. Recargar sin mostrar alerta
        setTimeout(() => {
          forceReload = true;
          window.location.reload();
        }, 1500);

      } else {
        // Mostrar errores de validación
        showFormErrors(form, data.errors);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Solicitar';
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <h6>Error de conexión</h6>
          <p>No se pudo conectar con el servidor. Intente nuevamente.</p>
        </div>
      `;
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Solicitar';
      }
    });
  }

  // Función auxiliar para obtener el valor de la cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
