{% extends "base.html" %}
{% block content %}
<div class="dashboard">
    <div class="header">
        <div class="header-left">
            <div class="logo-container">
                <img src="/static/img/EasyCert" alt="EasyCert Logo" class="logo-img">
                <span class="logo-text">EASYCERT</span>
            </div>
        </div>
        <div class="header-right">
            <span class="welcome-text">Hola, {{ user.nombres }}</span>
            <a href="{% url 'logout' %}" class="logout-button">Cerrar Sesión</a>
</div>
</div>
<div class="content">
    
    <!-- Listado de solicitudes en tabla -->
     <div style="width: 1200px; height: 520px; overflow: auto;">
    <div class="solicitudes">
      <div class="solicitudes-header">
        <h2>Solicitudes de Constancias</h2>
        <span class="badge-count">{{ solicitudes|length }} solicitudes</span>
        <button type="button" class="btn btn-primary" id="abrirFormularioBtn">
        Solicitar constancia
        </button>
      </div>

      <div class="table-container">
        <table class="solicitudes-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Documento</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for s in solicitudes %}
            <tr class="solicitud-row " data-tipo="{{ s.tipo }}" data-estado="{{ s.estado }}" data-fecha="{{ s.creado_en|date:'Y-m-d' }}">
              <td>{{ s.usuario.nombres }} {{ s.usuario.apellidos }}</td>
              <td>{{ s.usuario.numero_documento }}</td>
              <td>
                <span class="status-badge {{ s.estado }}">{{ s.get_estado_display }}</span>
              </td>
              <td class="action-buttons">
                <a href="#" class="btn btn-primary" title="Descargar PDF">
                    Descargar PDF
                  <i class="fas fa-upload"></i>
                </a>
                
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>No hay solicitudes</h3>
                <p>No se encontraron solicitudes de constancias.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% comment %} Modal para solicitar constancia {% endcomment %}
<div class="modal fade" id="formularioModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" 
     data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar Constancia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="modalFormularioContenido">
        <!-- Aquí se cargará el formulario vía AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let formDirty = false;        // Detecta si hay cambios en el formulario
  let formOpened = false;       // Detecta si el modal ya fue abierto
  let formSubmitted = false;    // Detecta si el formulario fue enviado correctamente
  let forceReload = false;      // Evita la alerta cuando la recarga es intencional

  const abrirBtn = document.getElementById("abrirFormularioBtn");
  const modalBody = document.getElementById("modalFormularioContenido");
  const modalEl = document.getElementById("formularioModal");
  const modal = new bootstrap.Modal(modalEl);

  // --- Mostrar advertencia SOLO si el formulario fue abierto, tiene cambios y no es recarga intencional
  window.addEventListener('beforeunload', function (e) {
    if (formOpened && formDirty && !formSubmitted && !forceReload) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // --- Marcar formulario como "dirty" cuando el usuario cambia algo
  document.addEventListener('input', (e) => {
    if (e.target.closest && e.target.closest('#constanciaForm')) {
      formDirty = true;
    }
  });
  document.addEventListener('change', (e) => {
    if (e.target.closest && e.target.closest('#constanciaForm')) {
      formDirty = true;
    }
  });

  // --- Abrir modal y cargar formulario por AJAX
  abrirBtn.addEventListener("click", function () {
    fetch("{% url 'formulario_constancia' %}", {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
      modalBody.innerHTML = data.form_html;

      const form = document.getElementById("constanciaForm");
      if (form) {
        // Sincronizar valores iniciales
        form.querySelectorAll('input, textarea, select').forEach(input => {
          try { input.defaultValue = input.value; } catch(e){ /* ignore */ }
        });

        // Reseteamos estados
        formDirty = false;
        formOpened = true;
        formSubmitted = false;

        // Asociar evento de submit
        form.addEventListener("submit", handleFormSubmit);
      }

      modal.show();
    })
    .catch(error => {
      modalBody.innerHTML = `<div class="alert alert-danger">Error al cargar el formulario</div>`;
      modal.show();
    });
  });

  // --- Manejo de envío del formulario
  function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');

    // Mostrar loading
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
    }

    fetch("{% url 'procesar_constancia' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie('csrftoken')
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Error en la respuesta del servidor');
      return response.json();
    })
    .then(data => {
      if (data.success) {
        formSubmitted = true; 
        formDirty = false;

        // 1. Limpiar y sincronizar formulario
        form.reset();
        form.querySelectorAll('input, textarea, select').forEach(input => {
          try { input.defaultValue = input.value; } catch(e){/* ignore */ }
        });

        // 2. Mostrar mensaje de éxito
        modalBody.innerHTML = `
          <div class="alert alert-success text-center">
            <h4>¡Solicitud enviada!</h4>
            <p>${data.message}</p>
            <p>La página se recargará automáticamente...</p>
          </div>
        `;

        // 3. Recargar sin mostrar alerta
        setTimeout(() => {
          forceReload = true;
          window.location.reload();
        }, 1500);

      } else {
        // Mostrar errores de validación
        showFormErrors(form, data.errors);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Solicitar';
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <h6>Error de conexión</h6>
          <p>No se pudo conectar con el servidor. Intente nuevamente.</p>
        </div>
      `;
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Solicitar';
      }
    });
  }

  // --- Mostrar errores en campos
  function showFormErrors(form, errors) {
    form.querySelectorAll('.is-invalid, .invalid-feedback').forEach(el => {
      if (el.classList) el.classList.remove('is-invalid');
      if (el.classList && el.classList.contains('invalid-feedback')) el.remove();
    });

    for (const field in errors) {
      const fieldElement = form.querySelector(`[name="${field}"]`);
      if (fieldElement) {
        fieldElement.classList.add('is-invalid');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.innerHTML = errors[field].join('<br>');
        fieldElement.parentNode.appendChild(errorDiv);
      } else if (field === '__all__') {
        form.insertAdjacentHTML('afterbegin', `
          <div class="alert alert-danger">
            ${errors[field].join('<br>')}
          </div>
        `);
      }
    }
  }

  // --- Solo reset cuando se cierra el modal (sin recargar)
  modalEl.addEventListener("hidden.bs.modal", function () {
    const form = document.getElementById("constanciaForm");
    if (form) {
      form.reset();
      form.querySelectorAll('input, textarea, select').forEach(input => {
        try { input.defaultValue = input.value; } catch(e){/* ignore */ }
      });
    }
    formDirty = false;
    formOpened = false;
  });

  // --- Obtener CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>



{% endblock%}